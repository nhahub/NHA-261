@model STOCKUPMVC.ViewModels.PurchaseOrderEditViewModel

@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Edit Purchase Order";
}

<h2>Edit Purchase Order</h2>

<form asp-action="Edit" method="post">
    <input type="hidden" asp-for="POID" />

    <!-- Supplier -->
    <div class="form-group">
        <label>Supplier</label>
        <select asp-for="SupplierID" class="form-control" asp-items="ViewBag.Suppliers">
            <option value="">-- Select Supplier --</option>
        </select>
    </div>

    <!-- Warehouse -->
    <div class="form-group mt-3">
        <label>Warehouse</label>
        <select asp-for="WarehouseID" class="form-control" asp-items="ViewBag.Warehouses">
            <option value="">-- Select Warehouse --</option>
        </select>
        <span asp-validation-for="WarehouseID" class="text-danger"></span>
    </div>
    <!-- Status -->
    <div class="form-group mt-3">
        <label>Status</label>
        <select asp-for="Status" class="form-control" asp-items="ViewBag.Statuses">
            <option value="">-- Select Status --</option>
        </select>
    </div>



    <hr />

    <!-- Order Items Table -->
    <table class="table" id="orderItemsTable">
        <thead>
            <tr>
                <th>Category</th>
                <th>Product</th>
                <th>Unit Price</th>
                <th>Qty</th>
                <th>Total</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            @for (int i = 0; i < Model.OrderItems.Count; i++)
            {
                <tr>
                    <td>
                        <select name="OrderItems[@i].CategoryID" class="form-control category-select">
                            <option value="">--Select--</option>
                            @foreach (var cat in ViewBag.Categories)
                            {
                                <option value="@cat.Value" selected="@(cat.Value == Model.OrderItems[i].CategoryID.ToString())">@cat.Text</option>
                            }

                        </select>
                    </td>
                    <td>
                        <select name="OrderItems[@i].ProductID" class="form-control product-select">
                            <option value="">--Select--</option>
                            <!-- We'll fill products via JS on category change or pre-select if needed -->
                        </select>
                    </td>
                    <td><input type="text" name="OrderItems[@i].UnitPrice" class="form-control unit-price" value="@Model.OrderItems[i].UnitPrice" readonly /></td>
                    <td><input type="number" name="OrderItems[@i].Quantity" class="form-control quantity" value="@Model.OrderItems[i].Quantity" min="1" /></td>
                    <td><input type="text" class="form-control total" value="@(Model.OrderItems[i].TotalPrice)" readonly /></td>
                    <td><button type="button" class="btn btn-danger remove-row">X</button></td>
                </tr>
            }
        </tbody>
    </table>

    <button type="button" class="btn btn-primary" id="addRow">Add Item</button>

    <div class="mt-3">
        <label>Total PO Amount: </label>
        <span id="poTotal">@Model.TotalAmount</span>
    </div>

    <button type="submit" class="btn btn-success mt-3">Update</button>
</form>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function () {

            function recalcTotal(row) {
                let qty = parseFloat(row.find(".quantity").val()) || 0;
                let price = parseFloat(row.find(".unit-price").val()) || 0;
                row.find(".total").val((qty * price).toFixed(2));
                recalcPOTotal();
            }

            function recalcPOTotal() {
                let total = 0;
                $("#orderItemsTable tbody tr").each(function () {
                    total += parseFloat($(this).find(".total").val()) || 0;
                });
                $("#poTotal").text(total.toFixed(2));
            }

            // Add row
            $("#addRow").click(function () {
                let rowCount = $("#orderItemsTable tbody tr").length;
                let newRow = $("#orderItemsTable tbody tr:first").clone();
                newRow.find("select, input").val('');

                newRow.find(".category-select").attr("name", `OrderItems[${rowCount}].CategoryID`);
                newRow.find(".product-select").attr("name", `OrderItems[${rowCount}].ProductID`);
                newRow.find(".unit-price").attr("name", `OrderItems[${rowCount}].UnitPrice`);
                newRow.find(".quantity").attr("name", `OrderItems[${rowCount}].Quantity`);

                $("#orderItemsTable tbody").append(newRow);
            });

            // Remove row
            $(document).on("click", ".remove-row", function () {
                if ($("#orderItemsTable tbody tr").length > 1)
                    $(this).closest("tr").remove();

                $("#orderItemsTable tbody tr").each(function (index) {
                    $(this).find(".category-select").attr("name", `OrderItems[${index}].CategoryID`);
                    $(this).find(".product-select").attr("name", `OrderItems[${index}].ProductID`);
                    $(this).find(".unit-price").attr("name", `OrderItems[${index}].UnitPrice`);
                    $(this).find(".quantity").attr("name", `OrderItems[${index}].Quantity`);
                });

                recalcPOTotal();
            });

            // Category change → load products
            $(document).on("change", ".category-select", function () {
                let row = $(this).closest("tr");
                let categoryId = $(this).val();
                let productSelect = row.find(".product-select");
                productSelect.empty().append('<option value="">--Select--</option>');
                row.find(".unit-price").val('');
                row.find(".total").val('');

                if (categoryId) {
                    $.getJSON('/PurchaseOrder/GetProductsByCategory', { categoryId: categoryId }, function (data) {
                        $.each(data, function (i, product) {
                            productSelect.append(
                                `<option value="${product.productID}" data-price="${product.price}">${product.name}</option>`
                            );
                        });
                    });
                }
            });

            // Product change → set unit price
            $(document).on("change", ".product-select", function () {
                let row = $(this).closest("tr");
                let price = $(this).find("option:selected").data("price") || 0;
                row.find(".unit-price").val(price.toFixed(2));
                recalcTotal(row);
            });

            // Quantity change
            $(document).on("input", ".quantity", function () {
                let row = $(this).closest("tr");
                recalcTotal(row);
            });

            // Recalculate totals on page load
            $("#orderItemsTable tbody tr").each(function () { recalcTotal($(this)); });
        });
    </script>
}
